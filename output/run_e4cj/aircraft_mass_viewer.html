<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aircraft Mass Viewer - Three.js</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; overflow: hidden; background: #1a1a1a; }
    #canvas-container { width: 100vw; height: 100vh; position: relative; }

    #sidebar {
      position: fixed; top: 10px; right: 10px;
      width: 350px; max-height: calc(100vh - 20px);
      background: rgba(245,245,245,0.95);
      padding: 15px; overflow-y: auto;
      border: 1px solid #ddd; border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #sidebar h2 { margin-top: 0; color: #333; font-size: 18px; }
    #sidebar h3 { margin-top: 15px; margin-bottom: 10px; color: #555; font-size: 14px; }
    #sidebar table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
    #sidebar table td { padding: 5px; border-bottom: 1px solid #eee; }
    #sidebar table td:first-child { font-weight: bold; width: 60%; }

    #legend {
      position: fixed; top: 10px; left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 15px; border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1000;
      max-height: calc(100vh - 20px);
      overflow-y: auto;
      min-width: 200px;
    }
    #legend h3 { margin-top: 0; margin-bottom: 10px; color: #333; }
    .legend-item { display: flex; align-items: center; padding: 5px 0; cursor: pointer; user-select: none; }
    .legend-item:hover { background: rgba(0,0,0,0.05); }
    .legend-color { width: 20px; height: 20px; border: 1px solid #333; margin-right: 8px; flex-shrink: 0; }
    .legend-item.hidden { opacity: 0.3; }

    #info {
      position: fixed; bottom: 10px; left: 10px;
      background: rgba(0,0,0,0.7);
      color: white; padding: 10px; border-radius: 5px;
      font-size: 12px; z-index: 1000;
    }

    #tooltip {
      position: fixed;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 12px;
      pointer-events: none;
      z-index: 2000;
      display: none;
      max-width: 300px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    #tooltip.visible { display: block; }
    #tooltip h4 { margin: 0 0 5px 0; color: #4CAF50; font-size: 14px; }
    #tooltip p { margin: 3px 0; }
  </style>
</head>
<body>
  <div id="canvas-container"></div>

  <div id="legend">
    <h3>Components</h3>
    <div id="legend-content"></div>
  </div>

  <div id="sidebar">
    <div style='font-family: Arial, sans-serif; padding: 10px;'><h2 style='margin-top: 0;'>Aircraft Specifications</h2><h3>Performance</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Total Mass:</b></td><td>7.921 kg</td></tr><tr><td><b>Airspeed:</b></td><td>10.98 m/s</td></tr><tr><td><b>Thrust (Cruise):</b></td><td>2.73 N</td></tr><tr><td><b>Power (Cruise):</b></td><td>41.32 W</td></tr><tr><td><b>L/D Ratio:</b></td><td>28.46</td></tr><tr><td><b>Stall Speed:</b></td><td>9.15 m/s</td></tr></table><h3>Main Wing</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Wingspan:</b></td><td>6.038 m</td></tr><tr><td><b>Chord:</b></td><td>0.310 m</td></tr><tr><td><b>Area:</b></td><td>1.528 m²</td></tr><tr><td><b>Aspect Ratio:</b></td><td>24.11</td></tr></table><h3>Geometry</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Boom Length:</b></td><td>1.139 m</td></tr><tr><td><b>Boom Y Position:</b></td><td>0.755 m</td></tr><tr><td><b>CG Location (from LE):</b></td><td>0.077 m</td></tr></table><h3>Mass Properties</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Total Mass:</b></td><td>7.615 kg</td></tr><tr><td><b>CG X:</b></td><td>0.123 m</td></tr><tr><td><b>CG Y:</b></td><td>0.000 m</td></tr><tr><td><b>CG Z:</b></td><td>0.011 m</td></tr><tr><td><b>Ixx:</b></td><td>8.616 kg·m²</td></tr><tr><td><b>Iyy:</b></td><td>0.939 kg·m²</td></tr><tr><td><b>Izz:</b></td><td>9.471 kg·m²</td></tr></table><h3>Aerodynamics</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>CL:</b></td><td>0.868</td></tr><tr><td><b>CD:</b></td><td>0.0305</td></tr><tr><td><b>Lift:</b></td><td>77.70 N</td></tr><tr><td><b>Drag:</b></td><td>2.73 N</td></tr><tr><td><b>Static Margin:</b></td><td>0.490</td></tr><tr><td><b>Neutral Point X:</b></td><td>0.206 m</td></tr></table><h3>Mission</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Mission Date:</b></td><td>100</td></tr><tr><td><b>Operating Latitude:</b></td><td>37.3989°</td></tr><tr><td><b>Operating Altitude:</b></td><td>1200 m</td></tr></table><h3>Environment</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Temperature:</b></td><td>106.6 °F</td></tr><tr><td><b>Pressure:</b></td><td>87714 Pa</td></tr><tr><td><b>Density:</b></td><td>0.9712 kg/m³</td></tr></table><h3>Horizontal Stabilizer</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Span:</b></td><td>1.509 m</td></tr><tr><td><b>Chord:</b></td><td>0.125 m</td></tr><tr><td><b>Area:</b></td><td>0.189 m²</td></tr><tr><td><b>Aspect Ratio:</b></td><td>11.00</td></tr><tr><td><b>Angle of Attack:</b></td><td>-0.73°</td></tr><tr><td><b>Volume Coefficient:</b></td><td>0.500</td></tr><tr><td><b>Airfoil:</b></td><td>naca0010</td></tr></table><h3>Vertical Stabilizer</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Span (Height):</b></td><td>0.418 m</td></tr><tr><td><b>Root Chord:</b></td><td>0.293 m</td></tr><tr><td><b>Area (each):</b></td><td>0.087 m²</td></tr><tr><td><b>Total Area:</b></td><td>0.175 m²</td></tr><tr><td><b>Aspect Ratio:</b></td><td>2.00</td></tr><tr><td><b>Volume Coefficient:</b></td><td>0.0200</td></tr><tr><td><b>Airfoil:</b></td><td>naca0010</td></tr></table><h3>Power System</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Solar Panels:</b></td><td>49</td></tr><tr><td><b>Battery Capacity:</b></td><td>728.3 Wh</td></tr><tr><td><b>Panel Size:</b></td><td>125.0 mm</td></tr></table><div style='margin-top: 15px;'><h4 style='margin-bottom: 10px;'>Power Generation & Battery State</h4><div style='position: relative; height: 200px; width: 100%; max-height: 200px; overflow: hidden;'><canvas id='powerChart' style='max-height: 200px;'></canvas></div></div><h3>Propulsion</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Propeller Diameter:</b></td><td>0.400 m</td></tr><tr><td><b>Number of Motors:</b></td><td>2</td></tr></table><h3>Wing Configuration</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Structural AOA:</b></td><td>5.10°</td></tr><tr><td><b>Mean Aerodynamic Chord:</b></td><td>0.262 m</td></tr><tr><td><b>Airfoil:</b></td><td>s4110</td></tr></table><h3>Structural Details</h3><table style='width: 100%; border-collapse: collapse;'><tr><td><b>Boom Radius:</b></td><td>10.0 mm</td></tr><tr><td><b>Boom Spacing Fraction:</b></td><td>0.25</td></tr></table></div>
  </div>

  <div id="info">
    Left click: Rotate | Right click: Pan | Scroll: Zoom
  </div>

  <div id="tooltip"></div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const soln = {"Meta":{"run_id":"run_e4cj","timestamp_utc":"2025-12-18T23:09:51.102630+00:00"},"Mission":{"mission_date":100,"operating_lat":37.398928,"operating_altitude":1200},"Environment":{"temperature_K":314.6118954753899,"temperature_F":106.63141185570174,"pressure":87713.68566656993,"density":0.9712477412534749,"speed_of_sound":355.57620215400374},"Performance":{"airspeed":10.982847006396227,"thrust_cruise":2.7298589749554663,"thrust_climb":41.58215667244738,"power_cruise (all motors)":41.31608810265753,"power_cruise (one motor)":20.658044051328766,"power_shaft_cruise (one motor)":19.570248658315812,"min_climb_angle":30,"power_out_max":456.6904649510281,"total_mass":7.92095774648298,"togw":77.70459539498384,"stall_speed":9.15237251350197,"L_over_D":28.464692168334906},"Aerodynamics":{"CL":0.8680555569949491,"CD":0.03049587017704002,"Cm":-1.7751305133363728e-15,"L":77.70459538507362,"D":2.7298589749554663,"x_np":0.2060175162576757,"static_margin":0.49012218966792254},"Main Wing":{"wingspan":6.037513145960718,"chordlen":0.30999999000116885,"struct_defined_aoa":5.102887526041998,"S_w":1.5281616194358167,"MAC_w":0.26221526277857216,"b_w":6.069347591841858,"main_wing_area":1.5281616194358167,"main_wing_AR":24.10542165310789,"wing_airfoil":"s4110"},"HStab":{"hstab_AR":11.00000009,"hstab_aoa":-0.7335271591221816,"hstab_area":0.18867227072049528,"hstab_span":1.5093782864901795,"hstab_chordlen":0.12499999000199136,"L_H":1.0619136004413463,"V_H_actual":0.5,"hstab_airfoil":"naca0010"},"V Stab":{"vstab_AR":2.0,"vstab_area":0.0873417954249115,"vstab_area_total":0.174683590849823,"vstab_span":0.4179516609009025,"vstab_root_chord":0.2929516708989111,"L_V":1.0619136004413463,"V_V_actual":0.02,"vstab_airfoil":"naca0010"},"Geometry":{"cg_le_dist":0.07749999750029221,"boom_y":0.7546891432450897,"boom_length":1.1394135979416384,"boom_radius":0.01,"boom_spacing_frac":0.25},"Power":{"solar_panels_n":49.038632894133336,"battery_capacity":728.3305557623768,"battery_states":[412.24038324340773,425.45860599939004,438.66495329720107,451.8356942047553,464.9471577340083,477.97577277463074,490.89810798442574,503.69091161972113,516.3311512894799,528.7960536174747,541.063143797551,553.1102850276726,564.915717809064,576.4580990971842,587.716541291382,598.6706510496555,609.3005679137087,619.5870027270589,629.511275824775,639.0553549667599,648.201892976303,656.934265030442,665.2366055264946,673.0938444170349,680.4917428595778,687.4169279614882,693.8569263068794,699.8001958185489,705.2361553169354,710.1552108642289,714.5487775875894,718.4092951050719,721.7302338477414,724.5060883555004,726.7323518200392,728.291839075114,728.3305536923785,728.3301844067313,728.2610551936797,727.7000580019235,726.5765772559636,724.887342936845,722.6268668272604,719.7856529973894,716.348254741827,712.2918476002386,707.5886716270903,702.2225715132128,696.2401117736418,689.831695938021,683.2437450296725,676.6315320997073,670.0193191697421,663.4071062397768,656.7948933098115,650.1826803798463,643.570467449881,636.9582545199157,630.3460415899506,623.7338286599853,617.1216157300199,610.5094028000548,603.8971898700896,597.2849769401242,590.6727640101591,584.0605510801938,577.4483381502286,570.8361252202633,564.2239122902981,557.6116993603329,550.9994864303676,544.3872735004023,537.7750605704371,531.1628476404718,524.5506347105065,517.9384217805414,511.32620885057605,504.7139959206108,498.1017829906456,491.4895700606803,484.87735713071515,478.2651442007498,471.6529312707845,465.0407183408193,458.42850541085403,451.81629248088876,445.20407955092355,438.5918666209583,431.979653690993,425.3674407610278,418.75522783106254,412.1430149010973,405.53080197113206,398.9185890411668,392.30637611120153,385.69416318123626,379.081950251271,372.4697373213058,365.8575243913405,359.24531146137525,352.63309853141004,346.02088560144483,339.40867267147956,332.79645974151435,326.18424681154903,319.5720338815838,312.9598209516186,306.3476080216533,299.7353950916881,293.1231821617228,286.5109692317576,279.8987563017924,273.2865433718271,266.67433044186185,260.06211751189664,253.44990458193132,246.83769165196608,240.2254787220008,233.61326579203552,227.00105286207025,220.38883993210493,213.77662700213963,207.1644140721744,200.55220114220907,193.93998821224383,187.32777528227857,180.7155623523133,174.10334942234803,167.4911364923827,160.87892356241744,154.26671063245217,147.6787597241037,141.27034388848273,135.28788414891184,129.92178403503425,125.21860806188592,121.16220092029756,117.72480266473518,114.88358883486414,112.62311272527955,110.93387840616089,109.81039766261406,109.24958335670105,109.24958335582828,109.80897621537342,110.92622963386303,112.59934138347438,114.82560485947056,117.60145936722975,120.92239810989905,124.7829156273816,129.17648235074208,134.09553789803562,139.53149739642197,145.47476690809157,151.91476525348276,158.8399503553931,166.23784879793612,174.09508768847647,182.39742818452905,191.1298002386681,200.27633824821118,209.82041739019607,219.74469048791198,230.03112530126236,240.6610421653157,251.6151519235891,262.8735941177867,274.41597540590686,286.22140818729827,298.2685494174199,310.53563959749613,323.00054192549106,335.64078159524973,348.4335852305452,361.35592044034007,374.38453548096265,387.49599901021566,400.6667399177698,413.87308721558077],"battery_voltage":22.2,"solar_panel_side_length":0.125,"solar_panels_n_rows":2,"solar_encapsulation_eff_hit":0.1,"solar_cell_efficiency":0.2187,"energy_generation_margin":1.05,"num_packs":6.561536538399791},"Propulsion":{"propeller_n":2,"propeller_diameter":0.4,"advanced_ratio":0.8,"motor_kv":92.76053216782081,"rpm_cruise":2059.283813699292,"i_cruise":0.8815427325390726},"Masses":{"mass_solar_cells":0.3923090631530667,"mass_power_board":0.15,"mass_batteries":3.1944322621156878,"mass_wires":0.07602406965106699,"mass_avionics":0.33999999999999997,"mass_servos":0.08,"mass_motors_mounted":0.6050000000000001,"mass_esc":0.06,"mass_propellers":0.11,"mass_main_wing":1.8601172389604779,"mass_hstab":0.12633193372304105,"mass_vstab":0.1116487312501445,"mass_boom":0.2050944476294949,"mass_fuselages":0.25,"mass_superstructures":0.2,"mass_boom_vstab_interfaces":0.1,"mass_vstab_stab_interfaces":0.06,"total_mass":7.92095774648298}};
    const massProperties = {"components":{"Main wing":{"mass":1.8601172389604779,"x_cg":0.07749999750029221,"y_cg":0.0,"z_cg":0.0,"Ixx":5.650563210423919,"Iyy":0.008593755040505668,"Izz":5.658727948052106,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Horizontal stabilizer":{"mass":0.12633193372304105,"x_cg":1.243901513166864,"y_cg":0.0,"z_cg":0.4179516609009025,"Ixx":0.023986002718252693,"Iyy":0.00016613962584517865,"Izz":0.02414885245051678,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Vertical stabilizer L":{"mass":0.05582436562507225,"x_cg":1.2126515156663662,"y_cg":0.7546891432450897,"z_cg":0.20897583045045126,"Ixx":0.0008133602666695527,"Iyy":0.0010157917337813589,"Izz":0.00020388522640073722,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Vertical stabilizer R":{"mass":0.05582436562507225,"x_cg":1.2126515156663662,"y_cg":-0.7546891432450897,"z_cg":0.20897583045045126,"Ixx":0.0008133602666695527,"Iyy":0.0010157917337813589,"Izz":0.00020388522640073722,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Boom L":{"mass":0.10254722381474746,"x_cg":0.5697067989708192,"y_cg":0.7546891432450897,"z_cg":-0.02,"Ixx":5.127361190737373e-06,"Iyy":0.011097005516692628,"Izz":0.011097005516692628,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Boom R":{"mass":0.10254722381474746,"x_cg":0.5697067989708192,"y_cg":-0.7546891432450897,"z_cg":-0.02,"Ixx":5.127361190737373e-06,"Iyy":0.011097005516692628,"Izz":0.011097005516692628,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Fuselage L":{"mass":0.125,"x_cg":-0.25,"y_cg":0.7546891432450897,"z_cg":-0.02,"Ixx":8.794701528334989e-05,"Iyy":0.0026481401743083414,"Izz":0.0026481401743083414,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Fuselage R":{"mass":0.125,"x_cg":-0.25,"y_cg":-0.7546891432450897,"z_cg":-0.02,"Ixx":8.794701528334989e-05,"Iyy":0.0026481401743083414,"Izz":0.0026481401743083414,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Solar cells":{"mass":0.3923090631530667,"x_cg":0.15499999500058442,"y_cg":0.0,"z_cg":0.001,"Ixx":1.1916900733336462,"Iyy":0.0005266905421440228,"Izz":1.1922165023364149,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Batteries":{"mass":3.1944322621156878,"x_cg":0.15499999500058442,"y_cg":0.0,"z_cg":0.0,"Ixx":0.6067086199256532,"Iyy":0.010887689960044303,"Izz":0.61711714504638,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"FC":{"mass":0.08,"x_cg":0.17979999420067794,"y_cg":0.0,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"GPS":{"mass":0.02,"x_cg":0.17979999420067794,"y_cg":0.0,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Telemetry":{"mass":0.03,"x_cg":0.17979999420067794,"y_cg":0.0,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Receiver":{"mass":0.02,"x_cg":0.17979999420067794,"y_cg":0.0,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Navlight Port":{"mass":0.01,"x_cg":0.17979999420067794,"y_cg":-1.5093782864901795,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Navlight Starboard":{"mass":0.01,"x_cg":0.17979999420067794,"y_cg":1.5093782864901795,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Navlight Center":{"mass":0.01,"x_cg":0.17979999420067794,"y_cg":0.0,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Navlight Hstab":{"mass":0.01,"x_cg":1.2851515098675212,"y_cg":0.0,"z_cg":0.4179516609009025,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Motor L":{"mass":0.30250000000000005,"x_cg":-0.5,"y_cg":0.7546891432450897,"z_cg":-0.02,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Motor R":{"mass":0.30250000000000005,"x_cg":-0.5,"y_cg":-0.7546891432450897,"z_cg":-0.02,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"ESC L":{"mass":0.03,"x_cg":-0.25,"y_cg":0.7546891432450897,"z_cg":-0.01,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"ESC R":{"mass":0.03,"x_cg":-0.25,"y_cg":-0.7546891432450897,"z_cg":-0.01,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Prop L":{"mass":0.055,"x_cg":-0.5,"y_cg":0.7546891432450897,"z_cg":0.0,"Ixx":0.0011000000000000003,"Iyy":0.0005500000000000001,"Izz":0.0005500000000000001,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Prop R":{"mass":0.055,"x_cg":-0.5,"y_cg":-0.7546891432450897,"z_cg":0.0,"Ixx":0.0011000000000000003,"Iyy":0.0005500000000000001,"Izz":0.0005500000000000001,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Superstructure L":{"mass":0.1,"x_cg":0.07749999750029221,"y_cg":0.7546891432450897,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Superstructure R":{"mass":0.1,"x_cg":0.07749999750029221,"y_cg":-0.7546891432450897,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Power board L":{"mass":0.075,"x_cg":0.07749999750029221,"y_cg":0.7546891432450897,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Power board R":{"mass":0.075,"x_cg":0.07749999750029221,"y_cg":-0.7546891432450897,"z_cg":0.0,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Boom_vstab interface L":{"mass":0.05,"x_cg":1.1394135979416384,"y_cg":0.7546891432450897,"z_cg":-0.02,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Boom_vstab interface R":{"mass":0.05,"x_cg":1.1394135979416384,"y_cg":-0.7546891432450897,"z_cg":-0.02,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Vstab_hstab interface L":{"mass":0.03,"x_cg":1.2126515156663662,"y_cg":0.7546891432450897,"z_cg":0.4179516609009025,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0},"Vstab_hstab interface R":{"mass":0.03,"x_cg":1.2126515156663662,"y_cg":-0.7546891432450897,"z_cg":0.4179516609009025,"Ixx":0.0,"Iyy":0.0,"Izz":0.0,"Ixy":0.0,"Iyz":0.0,"Ixz":0.0}},"total":{"mass":7.614933676831912,"x_cg":0.1225912345824854,"y_cg":0.0,"z_cg":0.01076563076040325,"Ixx":8.615955755691765,"Iyy":0.9392988465514572,"Izz":9.471186914511371,"Ixy":-6.938893903907228e-18,"Iyz":1.734723475976807e-18,"Ixz":-0.12259847088904287},"total_mass_verification":{"calculated":7.614933676831912,"expected":7.92095774648298,"difference":-0.3060240696510679}};
    const airplaneGeometry = {"wings":[{"name":"Main Wing","symmetric":true,"xsecs":[{"xyz_le":[0.0,0.0,0.0],"chord":0.30999999000116885},{"xyz_le":[0.0,0.7546891432450897,0.0],"chord":0.30999999000116885},{"xyz_le":[0.0,3.018756572980359,0.2621007888590536],"chord":0.15499999500058442}]},{"name":"Horizontal Stabilizer","symmetric":true,"xsecs":[{"xyz_le":[1.2126515156663662,0.0,0.4179516609009025],"chord":0.12499999000199136},{"xyz_le":[1.2126515156663662,0.7546891432450897,0.4179516609009025],"chord":0.12499999000199136}]},{"name":"Vertical Stabilizer L","symmetric":false,"xsecs":[{"xyz_le":[1.1394135979416384,0.7546891432450897,0.0],"chord":0.2929516708989111},{"xyz_le":[1.2126515156663662,0.7546891432450897,0.4179516609009025],"chord":0.12499999000199136}]},{"name":"Vertical Stabilizer R","symmetric":false,"xsecs":[{"xyz_le":[1.1394135979416384,-0.7546891432450897,0.0],"chord":0.2929516708989111},{"xyz_le":[1.2126515156663662,-0.7546891432450897,0.4179516609009025],"chord":0.12499999000199136}]}],"fuselages":[{"name":"Left Fuse","xsecs":[{"xyz_c":[-0.5,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4985344892885899,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.49415513892752166,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4869132927957006,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4768938549177392,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4642142940418973,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4490232664264109,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4314988729807827,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4118465711954569,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.39029676634059557,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.36710211017494754,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.34253453883497853,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.31688208463230516,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.2904454991381911,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.2635347271463544,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.2364652728536456,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.20955450086180877,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.18311791536769473,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.15746546116502136,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.13289788982505246,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.10970323365940438,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.08815342880454308,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.06850112701921729,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.050976733573589006,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.035785705958102654,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.02310614508226072,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.013086707204299386,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.005844861072478336,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.0014655107114101007,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.0,0.7546891432450897,-0.02],"radius":0.0}]},{"name":"Right Fuselage","xsecs":[{"xyz_c":[-0.5,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4985344892885899,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.49415513892752166,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4869132927957006,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4768938549177392,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4642142940418973,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4490232664264109,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4314988729807827,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.4118465711954569,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.39029676634059557,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.36710211017494754,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.34253453883497853,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.31688208463230516,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.2904454991381911,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.2635347271463544,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.2364652728536456,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.20955450086180877,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.18311791536769473,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.15746546116502136,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.13289788982505246,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.10970323365940438,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.08815342880454308,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.06850112701921729,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.050976733573589006,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.035785705958102654,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.02310614508226072,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.013086707204299386,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.005844861072478336,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[-0.0014655107114101007,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.0,-0.7546891432450897,-0.02],"radius":0.0}]},{"name":"Boom L","xsecs":[{"xyz_c":[0.0,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.00777005818056927,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.03086828579014103,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.06866462339211174,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.1201280854243982,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.1838548827979927,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.25810671460390605,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.34085818443055216,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.4298520478980424,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.5226607844006714,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.6167528135409671,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.7095615500435961,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.7985554135110863,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.8813068833377324,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.9555587151436458,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[1.0192855125172404,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[1.0707489745495267,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[1.1085453121514974,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[1.1316435397610691,0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[1.1394135979416384,0.7546891432450897,-0.02],"radius":0.0}]},{"name":"Boom R","xsecs":[{"xyz_c":[0.0,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.00777005818056927,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.03086828579014103,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.06866462339211174,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.1201280854243982,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.1838548827979927,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.25810671460390605,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.34085818443055216,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.4298520478980424,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.5226607844006714,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.6167528135409671,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.7095615500435961,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.7985554135110863,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.8813068833377324,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[0.9555587151436458,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[1.0192855125172404,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[1.0707489745495267,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[1.1085453121514974,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[1.1316435397610691,-0.7546891432450897,-0.02],"radius":0.0},{"xyz_c":[1.1394135979416384,-0.7546891432450897,-0.02],"radius":0.0}]}],"xyz_ref":[0.07749999750029221,0.0,0.0]};

    const batteryStates = soln.Power?.battery_states || null;
    const batteryCapacity = soln.Power?.battery_capacity || 0;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);

    // Align to expected aircraft view: rotate scene instead of remapping every component
    scene.rotation.z = Math.PI;
    scene.rotation.x = -Math.PI / 2;

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(5, 5, 5);
    camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(10, 10, 5);
    directionalLight.castShadow = true;
    scene.add(directionalLight);

    function getColorForCategory(name) {
      const n = name.toLowerCase();
      if (n.includes('wing') || n.includes('stabilizer')) return 0x4A90E2;
      if (n.includes('boom') || n.includes('fuselage') || n.includes('superstructure') || n.includes('interface')) return 0x8B7355;
      if (n.includes('motor') || n.includes('esc') || n.includes('prop')) return 0xE67E22;
      if (n.includes('batter')) return 0xE74C3C;
      if (n.includes('solar')) return 0xF1C40F;
      if (n.includes('fc') || n.includes('gps') || n.includes('telemetry') || n.includes('receiver') || n.includes('navlight') || n.includes('power board')) return 0x27AE60;
      return 0x9B59B6;
    }

    function createMeshPhong(color, opacity=0.7) {
      return new THREE.MeshPhongMaterial({
        color, opacity, transparent: opacity < 1.0, side: THREE.DoubleSide
      });
    }

    function createBox(center, Lx, Ly, Lz, color, userData) {
      const geometry = new THREE.BoxGeometry(Lx, Ly, Lz, 8, 8, 8);
      const material = createMeshPhong(color, 0.7);
      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(center[0], center[1], center[2]);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      mesh.userData = userData;
      mesh.userData.originalMaterial = material.clone();
      return mesh;
    }

    function createCylinder(center, radius, length, axis, color, userData) {
      const geometry = new THREE.CylinderGeometry(radius, radius, length, 64);
      const material = createMeshPhong(color, 0.7);
      const mesh = new THREE.Mesh(geometry, material);

      if (axis === 'x') mesh.rotation.z = Math.PI / 2;
      else if (axis === 'z') mesh.rotation.x = Math.PI / 2;

      mesh.position.set(center[0], center[1], center[2]);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      mesh.userData = userData;
      mesh.userData.originalMaterial = material.clone();
      return mesh;
    }

    function createSphere(center, radius, color, userData) {
      const geometry = new THREE.SphereGeometry(radius, 32, 32);
      const material = createMeshPhong(color, 0.8);
      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(center[0], center[1], center[2]);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      mesh.userData = userData;
      mesh.userData.originalMaterial = material.clone();
      return mesh;
    }

    function reconstructGeometry(soln, massProperties) {
      const mainWing = soln['Main Wing'] || soln.Main_Wing || {};
      const geometry = soln.Geometry || {};
      const hstab = soln.HStab || {};
      const vstab = soln['V Stab'] || soln.V_Stab || {};
      const power = soln.Power || {};
      const propulsion = soln.Propulsion || {};
      const airfoils = soln.airfoils || {};

      const b_w = mainWing.wingspan || mainWing.b_w || 0;
      const c_root = mainWing.chordlen || 0;
      const boom_len = geometry.boom_length || 0;
      const boom_y = geometry.boom_y || 0;
      const vstab_span = vstab.vstab_span || 0;
      const vstab_root_chord = vstab.vstab_root_chord || 0;
      const hstab_chord = hstab.hstab_chordlen || 0;
      const hstab_span = hstab.hstab_span || 0;

      const wing_t_over_c = airfoils.wing_t_over_c || 0.12;
      const tail_t_over_c = airfoils.tail_t_over_c || 0.10;
      const t_wing = wing_t_over_c * c_root;
      const t_tail = tail_t_over_c * Math.max(hstab_chord, 1e-6);

      const boom_radius = geometry.boom_radius || 0.01;
      const solar_panel_side_length = power.solar_panel_side_length || 0.125;

      const fuselage_length = 0.5;
      const fuselage_radius = 0.015;
      const batt_box = [0.20, 0.10, 0.03];

      const solar_panels_n = power.solar_panels_n || 0;
      const solar_area = solar_panels_n * solar_panel_side_length * solar_panel_side_length;
      const solar_mean_chord_covered = solar_area / Math.max(b_w, 1e-6);

      const prop_radius = 0.5 * (propulsion.propeller_diameter || 0.4);

      const components = massProperties.components || {};
      const geometryMap = {};

      // Precompute maxMass safely
      const masses = Object.values(components).map(c => c.mass || 0);
      const maxMass = Math.max(1e-9, ...(masses.length ? masses : [1e-9]));

      for (const [name, comp] of Object.entries(components)) {
        const x_cg = comp.x_cg || 0;
        const y_cg = comp.y_cg || 0;
        const z_cg = comp.z_cg || 0;
        const mass = comp.mass || 0;

        if (name === 'Main wing') {
          geometryMap[name] = { type: 'box', center: [x_cg, y_cg, z_cg], Lx: 0.75 * c_root, Ly: b_w, Lz: Math.max(t_wing, 0.005), mass };
        } else if (name === 'Horizontal stabilizer') {
          geometryMap[name] = { type: 'box', center: [x_cg, y_cg, z_cg], Lx: hstab_chord, Ly: hstab_span, Lz: Math.max(t_tail, 0.003), mass };
        } else if (name.includes('Vertical stabilizer')) {
          geometryMap[name] = { type: 'box', center: [x_cg, y_cg, z_cg], Lx: Math.max(0.5 * (vstab_root_chord + hstab_chord), 1e-6), Ly: Math.max(t_tail, 0.003), Lz: Math.max(vstab_span, 1e-6), mass };
        } else if (name === 'Boom L' || name === 'Boom R') {
          geometryMap[name] = { type: 'cylinder', center: [x_cg, y_cg, z_cg], radius: boom_radius, length: boom_len, axis: 'x', mass };
        } else if (name === 'Fuselage L' || name === 'Fuselage R') {
          geometryMap[name] = { type: 'cylinder', center: [x_cg, y_cg, z_cg], radius: fuselage_radius, length: fuselage_length, axis: 'x', mass };
        } else if (name === 'Solar cells') {
          geometryMap[name] = { type: 'box', center: [x_cg, y_cg, z_cg], Lx: Math.max(solar_mean_chord_covered, 0.05), Ly: b_w, Lz: 0.002, mass };
        } else if (name === 'Batteries') {
          geometryMap[name] = { type: 'box', center: [x_cg, y_cg, z_cg], Lx: batt_box[0], Ly: 2 * boom_y, Lz: batt_box[2], mass };
        } else if (name === 'Prop L' || name === 'Prop R') {
          geometryMap[name] = { type: 'cylinder', center: [x_cg, y_cg, z_cg], radius: Math.max(prop_radius, 0.01), length: 0.001, axis: 'x', mass };
        } else {
          const sphereRadius = 0.05 * (mass / maxMass) + 0.02;
          geometryMap[name] = { type: 'point', center: [x_cg, y_cg, z_cg], radius: sphereRadius, mass };
        }
      }

      return geometryMap;
    }

    const geometryMap = reconstructGeometry(soln, massProperties);
    const components = massProperties.components || {};

    const componentMeshes = {};
    const legendContent = document.getElementById('legend-content');

    for (const [name, geom] of Object.entries(geometryMap)) {
      const color = getColorForCategory(name);
      const componentData = components[name] || {};

      const inertia = (componentData.Ixx !== undefined) ? {
        Ixx: componentData.Ixx, Iyy: componentData.Iyy, Izz: componentData.Izz,
        Ixy: componentData.Ixy || 0, Iyz: componentData.Iyz || 0, Ixz: componentData.Ixz || 0
      } : null;

      const userData = {
        name, type: geom.type, mass: geom.mass, center: geom.center, inertia
      };

      let mesh = null;
      if (geom.type === 'box') mesh = createBox(geom.center, geom.Lx, geom.Ly, geom.Lz, color, userData);
      else if (geom.type === 'cylinder') mesh = createCylinder(geom.center, geom.radius, geom.length, geom.axis, color, userData);
      else if (geom.type === 'point') mesh = createSphere(geom.center, geom.radius, color, userData);

      if (!mesh) continue;

      scene.add(mesh);
      componentMeshes[name] = mesh;

      const legendItem = document.createElement('div');
      legendItem.className = 'legend-item';
      legendItem.innerHTML = `
        <div class="legend-color" style="background-color: #${color.toString(16).padStart(6, '0')}"></div>
        <span>${name}</span>
      `;
      legendItem.onclick = () => {
        mesh.visible = !mesh.visible;
        legendItem.classList.toggle('hidden', !mesh.visible);
      };
      legendContent.appendChild(legendItem);
    }

    // Total CG marker
    const total = massProperties.total || {};
    const cgGeometry = new THREE.SphereGeometry(0.05, 32, 32);
    const cgMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });
    const cgMesh = new THREE.Mesh(cgGeometry, cgMaterial);
    cgMesh.position.set(total.x_cg || 0, total.y_cg || 0, total.z_cg || 0);
    cgMesh.userData = {
      name: 'Total CG', type: 'cg', mass: total.mass || 0,
      center: [total.x_cg || 0, total.y_cg || 0, total.z_cg || 0],
      originalMaterial: cgMaterial.clone()
    };
    scene.add(cgMesh);
    componentMeshes['Total CG'] = cgMesh;

    // Wireframe tube helper (visible lines)
    function createWireframeTube(start, end, radius=0.003, color=0x808080) {
      const direction = new THREE.Vector3().subVectors(end, start);
      const length = direction.length();
      const geometry = new THREE.CylinderGeometry(radius, radius, length, 8);
      const material = new THREE.MeshBasicMaterial({ color, depthWrite: false });
      const mesh = new THREE.Mesh(geometry, material);

      const midpoint = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
      mesh.position.copy(midpoint);

      const axis = new THREE.Vector3(0, 1, 0);
      const quaternion = new THREE.Quaternion();
      quaternion.setFromUnitVectors(axis, direction.normalize());
      mesh.quaternion.copy(quaternion);

      mesh.renderOrder = 1000;
      return mesh;
    }

    function addWireframe(airplaneGeometry) {
      if (!airplaneGeometry?.wings?.length) return;

      const wireframeColor = 0x808080;
      const wireframeRadius = 0.003;
      const xyz_ref = airplaneGeometry.xyz_ref || [0,0,0];

      for (const wing of airplaneGeometry.wings) {
        const xsecs = wing.xsecs || [];
        if (xsecs.length < 2) continue;

        function le(xsec) {
          return new THREE.Vector3(xsec.xyz_le[0] + xyz_ref[0], xsec.xyz_le[1] + xyz_ref[1], xsec.xyz_le[2] + xyz_ref[2]);
        }
        function te(xsec) {
          return new THREE.Vector3(xsec.xyz_le[0] + xsec.chord + xyz_ref[0], xsec.xyz_le[1] + xyz_ref[1], xsec.xyz_le[2] + xyz_ref[2]);
        }

        for (let i = 0; i < xsecs.length - 1; i++) {
          const a = xsecs[i], b = xsecs[i+1];
          scene.add(createWireframeTube(le(a), le(b), wireframeRadius, wireframeColor));
          scene.add(createWireframeTube(te(a), te(b), wireframeRadius, wireframeColor));
          scene.add(createWireframeTube(le(a), te(a), wireframeRadius, wireframeColor));
        }
        scene.add(createWireframeTube(le(xsecs[xsecs.length-1]), te(xsecs[xsecs.length-1]), wireframeRadius, wireframeColor));

        if (wing.symmetric) {
          for (let i = 0; i < xsecs.length - 1; i++) {
            const a = xsecs[i], b = xsecs[i+1];
            const leA = le(a); leA.y = -leA.y + 2*xyz_ref[1];
            const leB = le(b); leB.y = -leB.y + 2*xyz_ref[1];
            const teA = te(a); teA.y = -teA.y + 2*xyz_ref[1];
            const teB = te(b); teB.y = -teB.y + 2*xyz_ref[1];

            scene.add(createWireframeTube(leA, leB, wireframeRadius, wireframeColor));
            scene.add(createWireframeTube(teA, teB, wireframeRadius, wireframeColor));
            scene.add(createWireframeTube(leA, teA, wireframeRadius, wireframeColor));
          }
          const last = xsecs[xsecs.length-1];
          const leL = le(last); leL.y = -leL.y + 2*xyz_ref[1];
          const teL = te(last); teL.y = -teL.y + 2*xyz_ref[1];
          scene.add(createWireframeTube(leL, teL, wireframeRadius, wireframeColor));
        }
      }

      for (const fuselage of airplaneGeometry.fuselages || []) {
        const xsecs = fuselage.xsecs || [];
        if (xsecs.length < 2) continue;
        for (let i = 0; i < xsecs.length - 1; i++) {
          const a = xsecs[i], b = xsecs[i+1];
          const c1 = new THREE.Vector3(a.xyz_c[0] + xyz_ref[0], a.xyz_c[1] + xyz_ref[1], a.xyz_c[2] + xyz_ref[2]);
          const c2 = new THREE.Vector3(b.xyz_c[0] + xyz_ref[0], b.xyz_c[1] + xyz_ref[1], b.xyz_c[2] + xyz_ref[2]);
          scene.add(createWireframeTube(c1, c2, wireframeRadius, wireframeColor));
        }
      }
    }

    addWireframe(airplaneGeometry);

    scene.add(new THREE.AxesHelper(2));
    const gridHelper = new THREE.GridHelper(10, 10);
    gridHelper.rotation.x = -Math.PI / 2;
    scene.add(gridHelper);

    function createAxisLabel(text, position, color) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 64; canvas.height = 64;
      ctx.fillStyle = color;
      ctx.font = 'Bold 48px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, 32, 32);

      const texture = new THREE.CanvasTexture(canvas);
      const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
      sprite.position.set(position[0], position[1], position[2]);
      sprite.scale.set(0.5, 0.5, 1);
      return sprite;
    }

    scene.add(createAxisLabel('X', [2.5, 0, 0], '#ff0000'));
    scene.add(createAxisLabel('Y', [0, 2.5, 0], '#00ff00'));
    scene.add(createAxisLabel('Z', [0, 0, 2.5], '#0000ff'));

    // Hover tooltip + highlight
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const tooltip = document.getElementById('tooltip');
    const allMeshes = Object.values(componentMeshes);

    function restoreMaterial(mesh) {
      if (mesh?.userData?.originalMaterial) {
        mesh.material.dispose();
        mesh.material = mesh.userData.originalMaterial.clone();
      }
    }

    function highlightMesh(mesh) {
      if (!mesh?.material) return;
      const m = mesh.material.clone();
      m.emissive = new THREE.Color(0xffffff);
      m.emissiveIntensity = 0.5;
      mesh.material = m;
    }

    let hovered = null;

    function onMouseMove(event) {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const hits = raycaster.intersectObjects(allMeshes, true);

      if (hits.length) {
        const obj = hits[0].object;
        if (hovered !== obj) {
          if (hovered) restoreMaterial(hovered);
          hovered = obj;
          highlightMesh(obj);

          const ud = obj.userData || {};
          tooltip.style.left = (event.clientX + 10) + 'px';
          tooltip.style.top = (event.clientY + 10) + 'px';

          let content = `<h4>${ud.name || 'Component'}</h4>`;
          content += `<p><b>Type:</b> ${ud.type}</p>`;
          content += `<p><b>Mass:</b> ${(ud.mass ?? 0).toFixed(4)} kg</p>`;
          if (ud.center) {
            content += `<p><b>Position:</b> (${ud.center[0].toFixed(3)}, ${ud.center[1].toFixed(3)}, ${ud.center[2].toFixed(3)}) m</p>`;
          }
          if (ud.inertia) {
            content += `<p><b>Inertia (kg·m²):</b></p>`;
            content += `<p style="margin-left: 10px;">Ixx: ${ud.inertia.Ixx.toFixed(6)}</p>`;
            content += `<p style="margin-left: 10px;">Iyy: ${ud.inertia.Iyy.toFixed(6)}</p>`;
            content += `<p style="margin-left: 10px;">Izz: ${ud.inertia.Izz.toFixed(6)}</p>`;
            if (ud.inertia.Ixy || ud.inertia.Iyz || ud.inertia.Ixz) {
              content += `<p style="margin-left: 10px;">Ixy: ${(ud.inertia.Ixy || 0).toFixed(6)}</p>`;
              content += `<p style="margin-left: 10px;">Iyz: ${(ud.inertia.Iyz || 0).toFixed(6)}</p>`;
              content += `<p style="margin-left: 10px;">Ixz: ${(ud.inertia.Ixz || 0).toFixed(6)}</p>`;
            }
          }

          tooltip.innerHTML = content;
          tooltip.classList.add('visible');
        }
      } else {
        if (hovered) {
          restoreMaterial(hovered);
          hovered = null;
        }
        tooltip.classList.remove('visible');
      }
    }

    renderer.domElement.addEventListener('mousemove', onMouseMove);
    renderer.domElement.addEventListener('mouseleave', () => {
      if (hovered) restoreMaterial(hovered);
      hovered = null;
      tooltip.classList.remove('visible');
    });

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    });

    animate();

    // Battery/power chart
    if (batteryStates && batteryStates.length > 0) {
      const canvas = document.getElementById('powerChart');
      if (canvas) {
        canvas.style.height = '200px';
        canvas.style.maxHeight = '200px';

        const timeHours = Array.from({length: batteryStates.length}, (_, i) => (i / batteryStates.length) * 24);
        const dt = 24 / batteryStates.length;

        const powerGeneration = [];
        for (let i = 0; i < batteryStates.length - 1; i++) {
          const dE = batteryStates[i + 1] - batteryStates[i];
          powerGeneration.push(dE / dt);
        }
        if (powerGeneration.length) powerGeneration.push(powerGeneration[powerGeneration.length - 1]);

        new Chart(canvas, {
          type: 'line',
          data: {
            labels: timeHours.map(t => t.toFixed(1)),
            datasets: [
              {
                label: 'Battery State (Wh)',
                data: batteryStates,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                yAxisID: 'y',
                tension: 0.1,
                pointRadius: 0
              },
              {
                label: 'Power Generation (W)',
                data: powerGeneration,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                yAxisID: 'y1',
                tension: 0.1,
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              title: { display: true, text: '24-Hour Power Generation & Battery State' },
              legend: { display: true, position: 'top' }
            },
            scales: {
              x: { display: true, title: { display: true, text: 'Time (hours)' } },
              y: {
                type: 'linear', display: true, position: 'left',
                title: { display: true, text: 'Battery State (Wh)' },
                min: 0,
                max: batteryCapacity ? batteryCapacity * 1.1 : undefined
              },
              y1: {
                type: 'linear', display: true, position: 'right',
                title: { display: true, text: 'Power Generation (W)' },
                grid: { drawOnChartArea: false }
              }
            }
          }
        });
      }
    }
  </script>
</body>
</html>
